<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host - Bảng điều khiển</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Custom Scrollbar for Modal */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: #9CA3AF;
            border-radius: 9999px;
        }

        .modal-body::-webkit-scrollbar-track {
            background-color: #F3F4F6;
        }

        .modal-actions-center {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        body {
            background-color: #F3F4F6;
            font-family: Arial, sans-serif;
            padding: 1.5rem;
        }

        .container {
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: blue;
        }

        .flex-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-duration: 200ms;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            flex: 1 1 0%;
            cursor: pointer;
            border: none;
            height: 50px !important;
            margin-top: 10px;
        }

        button:hover {
            background-color: orange !important;
            color: #FFFFFF !important;
        }

        #createRoomBtn,
        #showParticipantsBtn {
            background-color: purple;
            color: #FFFFFF;
        }

        #joinRoomBtn {
            background-color: purple;
            color: #FFFFFF;
        }

        #roomCodeDisplay {
            display: none;
            padding: 0.75rem;
            background-color: purple;
            color: white;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-family: monospace;
            text-align: center;
            flex: 1 1 0%;
            font-weight: bold;
        }

        #bellStatusDisplay {
            width: 80%;
            margin: auto;
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #FFFFFF;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            background-color: red;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: red;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        input[type="number"] {
            width: 80%;
            display: block;
            margin-left: auto;
            margin-right: auto;
            padding: 0.5rem;
            border: 1px solid red;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        input[type="text"].modal-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: bold;
            box-sizing: border-box;
        }

        input[type="text"].modal-input:focus {
            outline: 2px solid transparent;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        input[type="number"]:focus {
            outline: 2px solid transparent;
            border-color: red;
            box-shadow: 0 0 0 3px red;
            font-weight: bold;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        #openBellInfiniteBtn,
        #resetBellBtn {
            background-color: blue;
            color: #FFFFFF;
        }

        #openBellTimedBtn,
        #showLockUsersBtn {
            background-color: green;
            color: #FFFFFF;
        }

        #lockBellBtn,
        #showBellOptionsBtn {
            background-color: #ff00cc;
            color: #FFFFFF;
        }

        .overflow-x-auto {
            width: 100%;
            overflow-x: auto;
        }

        .min-w-full {
            min-width: 100%;
        }

        table {
            border-collapse: collapse;
            border: 1px solid #D1D5DB;
        }

        thead th {
            padding: 1rem;
            background-color: rgb(255, 255, 0);
            color: #000000;
            font-weight: bold;
            font-size: 1.125rem;
            border: 1px solid #D1D5DB;
        }

        tbody {
            text-align: center;
            font-size: 1.125rem;
            font-weight: bold;
        }

        tbody td {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            background-color: #FFFFFF;
            color: #000000;
        }

        .latest-buzz {
            background-color: blue !important;
            color: white !important;
        }

        .latest-buzz td {
            background-color: blue !important;
            color: white !important;
            font-weight: bold;
        }

        .text-red-600 {
            color: #DC2626;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition-property: opacity;
            transition-duration: 300ms;
        }

        .modal-content {
            background-color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 32rem;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .modal-body {
            max-height: 16rem;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .modal-close-btn {
            background-color: rgb(255, 0, 0);
            color: #FFFFFF;
        }

        #lockUsersModal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #saveLockedUsersBtn {
            background-color: green;
            color: #FFFFFF;
        }

        #confirmJoinBtn {
            background-color: green;
            color: white;
            font-weight: bold;
        }

        #resetAllLocksBtn {
            background-color: rgb(255, 255, 0);
            color: #000000;
        }

        #lockUsersList>div {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        #lockUsersList input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            color: green;
        }

        #lockUsersList label {
            text-align: left;
            display: inline;
            color: #111827;
            font-weight: normal;
            font-size: 1rem;
            margin: 0;
            padding: 0;
            cursor: pointer;
        }

        #saveBellOptionsBtn {
            background-color: green;
            color: #FFFFFF;
            font-weight: bold;
        }

        #bellOptionsModal .flex.items-center label {
            display: inline;
            margin-bottom: 0;
            text-align: left;
        }

        #joinRoomModal label {
            text-align: left;
            color: #111827;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        #joinRoomModal .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: none;
        }

        /* --- CSS MỚI CHO TIMER CỦA HOST --- */
        #hostTimerDisplay {
            display: none;
            /* Mặc định ẩn */
            width: 80%;
            /* Căn chỉnh giống ô input bên dưới */
            margin: 0 auto 1rem auto;
            /* Căn giữa và tạo khoảng cách */
            background-color: #FFFF00;
            /* Màu vàng */
            color: #000000;
            /* Chữ đen */
            font-weight: bold;
            font-size: 2rem;
            /* Chữ to */
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 3px solid #000;
            /* Viền đen */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans p-6">

    <div class="container">
        <h1>Bảng điều khiển Host</h1>

        <div class="flex-wrap">
            <button id="createRoomBtn" disabled>Đang kết nối Server...</button>
            <button id="joinRoomBtn" disabled>Đang kết nối...</button>
            <div id="roomCodeDisplay">Mã phòng: </div>
            <button id="showParticipantsBtn" disabled>Danh sách tham gia</button>
        </div>

        <div id="bellControlSection" style="display: none;">
            <div id="bellStatusDisplay">CHUÔNG ĐANG KHÓA</div>

            <div id="hostTimerDisplay">0.000s</div>

            <label for="bellTimeInput">Thời gian mở chuông (giây):</label>
            <input type="number" id="bellTimeInput" value="10">

            <div class="grid-container">
                <button id="openBellInfiniteBtn" disabled>Mở chuông vĩnh viễn</button>
                <button id="openBellTimedBtn" disabled>Mở chuông (Giới hạn)</button>
                <button id="lockBellBtn" disabled>Khóa chuông</button>
            </div>

            <div class="grid-container">
                <button id="resetBellBtn" disabled>Reset chuông</button>
                <button id="showLockUsersBtn" disabled>Chọn người bị khóa chuông</button>
                <button id="showBellOptionsBtn" disabled>Tùy chọn chuông</button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Tên người chơi</th>
                            <th style="width: 50%;">Thời gian bấm chuông</th>
                        </tr>
                    </thead>
                    <tbody id="buzzTableBody">
                        <tr>
                            <td colspan="2">Chưa có ai bấm chuông</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="participantsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Danh sách người tham gia</h2>
            <div id="participantsList" class="modal-body"></div>
            <div class="modal-actions-center">
                <button onclick="closeModal('participantsModal')" class="modal-close-btn text-white">Đóng</button>
            </div>
        </div>
    </div>

    <div id="lockUsersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Chọn người bị khóa chuông</h2>
            <div id="lockUsersList" class="modal-body space-y-2"></div>
            <div class="mt-6 modal-actions">
                <button id="saveLockedUsersBtn">Lưu</button>
                <button id="resetAllLocksBtn">Reset tất cả</button>
                <button onclick="closeModal('lockUsersModal')" class="modal-close-btn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="bellOptionsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Tùy chọn chuông</h2>
            <div class="modal-body space-y-4">
                <div>
                    <h3 class="font-bold text-lg mb-2">Số lần bấm chuông/vòng:</h3>
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="opt-single-buzz" name="buzzCount" value="single" checked
                                class="mr-3">
                            <label for="opt-single-buzz" class="text-base text-gray-900">Mỗi người chỉ được bấm 1
                                lần/vòng</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="opt-multiple-buzz" name="buzzCount" value="multiple" class="mr-3">
                            <label for="opt-multiple-buzz" class="text-base text-gray-900">Mỗi người được bấm nhiều
                                lần</label>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">Chế độ người thắng:</h3>
                    <div class="flex flex-col space-y-2">
                        <div class="flex flex-col space-y-2">
                            <div class="flex items-center">
                                <input type="radio" id="opt-single-winner" name="buzzMode" value="single-winner" checked
                                    class="mr-3">
                                <label for="opt-single-winner" class="text-base text-gray-900">Một người bấm: Khóa
                                    chuông ngay lập tức</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="opt-all-buzz" name="buzzMode" value="all-buzz" class="mr-3">
                                <label for="opt-all-buzz" class="text-base text-gray-900">Tất cả đều bấm: Chỉ khóa
                                    chuông khi Host bấm Khóa</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions-center">
                <button id="saveBellOptionsBtn">Lưu</button>
                <button onclick="closeModal('bellOptionsModal')" class="modal-close-btn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="joinRoomModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Tham gia với tư cách Quản lý</h2>
            <div class="modal-body">
                <div>
                    <label for="joinRoomCodeInput">Nhập mã phòng:</label>
                    <input type="text" id="joinRoomCodeInput" class="modal-input">
                </div>
                <div>
                    <label for="joinUsernameInput">Nhập Username:</label>
                    <input type="text" id="joinUsernameInput" class="modal-input">
                </div>
            </div>
            <div class="modal-actions-center">
                <button id="confirmJoinBtn">Xác nhận</button>
                <button id="closeJoinModalBtn" class="modal-close-btn">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        // --- KHAI BÁO SOCKET.IO ---
        const SERVER_URL = 'https://buzz1.onrender.com';
        const socket = io(SERVER_URL);

        // Biến toàn cục
        let userId = null;
        let currentRoomId = null;
        let currentRoomData = null;
        let bellTimer = null;
        let currentParticipants = [];
        let isHost = false;
        let isManager = false;

        // Biến Timer hiển thị
        let countdownInterval = null;
        const hostTimerDisplay = document.getElementById('hostTimerDisplay');

        // --- SOCKET LISTENERS ---
        socket.on('connect', () => {
            userId = `host-${socket.id}`;
            document.getElementById('createRoomBtn').textContent = 'Tạo phòng';
            document.getElementById('createRoomBtn').disabled = false;
            document.getElementById('joinRoomBtn').textContent = 'Tham gia phòng (Quản lý)';
            document.getElementById('joinRoomBtn').disabled = false;
        });

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            isHost = true;
            isManager = false;

            document.getElementById('roomCodeDisplay').textContent = `Mã phòng: ${currentRoomId}`;
            document.getElementById('roomCodeDisplay').style.display = 'block';
            document.getElementById('createRoomBtn').textContent = `Mã phòng: ${currentRoomId}`;
            document.getElementById('createRoomBtn').disabled = true;
            document.getElementById('joinRoomBtn').style.display = 'none';

            enableButtons();
            updateBellUI("locked");
            document.getElementById('bellControlSection').style.display = 'block';
        });

        socket.on('joinedAsManager', (data) => {
            currentRoomId = data.roomId;
            isHost = false;
            isManager = true;

            document.getElementById('roomCodeDisplay').textContent = `Mã phòng: ${currentRoomId}`;
            document.getElementById('roomCodeDisplay').style.display = 'block';
            document.getElementById('createRoomBtn').textContent = `Đã tham gia: ${currentRoomId}`;
            document.getElementById('createRoomBtn').disabled = true;
            document.getElementById('joinRoomBtn').style.display = 'none';

            enableButtons();
            document.getElementById('bellControlSection').style.display = 'block';

            if (data.roomState) {
                handleRoomStateUpdate(data.roomState);
            } else {
                updateBellUI("locked");
            }
            closeModal('joinRoomModal');
        });

        socket.on('joinRoomError', (data) => { });

        socket.on('roomClosed', (data) => {
            window.location.reload();
        });

        socket.on('roomStateUpdate', handleRoomStateUpdate);

        function handleRoomStateUpdate(data) {
            currentRoomData = data;
            currentParticipants = Array.isArray(data.participants) ? data.participants : [];

            const playerCount = currentParticipants.filter(p => !p.isHost && !p.isManager).length;
            document.getElementById('showParticipantsBtn').textContent = `Danh sách tham gia (${playerCount})`;

            updateBellUI(data.bellStatus);
            updateBellOptionsUI(data.options);
            renderBuzzTable(data.buzzes || [], data.bellOpenTimestamp);

            // --- XỬ LÝ TIMER CHO HOST ---
            // Nếu đang mở chuông giới hạn, có thời gian bắt đầu và có duration
            if (data.bellStatus === 'open_timed' && data.bellOpenTimestamp && data.bellDuration) {
                startCountdown(data.bellDuration, data.bellOpenTimestamp);
            } else {
                stopCountdown(); // Tắt nếu bị khóa hoặc mở vô hạn
            }

            const lockedFromServer = Array.isArray(data.lockedUsers) ? data.lockedUsers : null;
            updateLockedUsersUI(lockedFromServer);
        }

        // --- HÀM QUẢN LÝ TIMER (LOCAL) ---
        function startCountdown(duration, startTime) {
            if (countdownInterval) clearInterval(countdownInterval);
            hostTimerDisplay.style.display = 'block';

            const updateTimer = () => {
                const now = Date.now();
                // Tính thời gian đã trôi qua
                const elapsed = (now - startTime) / 1000;
                // Thời gian còn lại
                const remaining = duration - elapsed;

                if (remaining <= 0) {
                    hostTimerDisplay.textContent = "0.000s";
                    clearInterval(countdownInterval);
                    // Host sẽ tự khóa bằng timeout trong openBell, hoặc server khóa.
                } else {
                    hostTimerDisplay.textContent = remaining.toFixed(3) + "s";
                }
            };
            // Chạy ngay 1 lần
            updateTimer();
            // Cập nhật mỗi 30ms
            countdownInterval = setInterval(updateTimer, 30);
        }

        function stopCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            hostTimerDisplay.style.display = 'none';
            hostTimerDisplay.textContent = "0.000s";
        }

        // --- UTILS ---
        function enableButtons() {
            const isController = isHost || isManager;
            document.getElementById('showParticipantsBtn').disabled = false;

            document.getElementById('openBellInfiniteBtn').disabled = !isController;
            document.getElementById('openBellTimedBtn').disabled = !isController;
            document.getElementById('lockBellBtn').disabled = !isController;
            document.getElementById('resetBellBtn').disabled = !isController;
            document.getElementById('showLockUsersBtn').disabled = !isController;
            document.getElementById('showBellOptionsBtn').disabled = !isController;

            if (!currentRoomId) {
                document.getElementById('showParticipantsBtn').disabled = true;
            }
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }

        function updateBellUI(status) {
            const display = document.getElementById('bellStatusDisplay');
            display.style.backgroundColor = 'red';
            display.textContent = 'CHUÔNG ĐANG KHÓA';

            if (status === 'open_infinite') {
                display.style.backgroundColor = 'blue';
                display.textContent = 'CHUÔNG ĐANG MỞ (VÔ HẠN)';
            } else if (status === 'open_timed') {
                display.style.backgroundColor = 'green';
                display.textContent = 'CHUÔNG ĐANG MỞ (CÓ GIỚI HẠN)';
            } else if (status === 'locked_winner') {
                display.style.backgroundColor = '#ff00cc';
                display.textContent = 'ĐÃ CÓ NGƯỜI BẤM! (CHUÔNG ĐÃ KHÓA)';
            }
        }

        function updateBellOptionsUI(options) {
            if (!options) return;
            document.getElementById('opt-single-buzz').checked = options.buzzCount === 'single';
            document.getElementById('opt-multiple-buzz').checked = options.buzzCount === 'multiple';
            document.getElementById('opt-single-winner').checked = options.buzzMode === 'single-winner';
            document.getElementById('opt-all-buzz').checked = options.buzzMode === 'all-buzz';
        }

        function renderBuzzTable(buzzes, bellOpenTimestamp) {
            const tableBody = document.getElementById('buzzTableBody');
            if (buzzes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2">Chưa có ai bấm chuông</td></tr>`;
                return;
            }

            const isMultipleBuzz = currentRoomData.options.buzzCount === 'multiple';
            let latestBuzzPerUser = new Map();

            if (isMultipleBuzz) {
                buzzes.forEach(buzz => {
                    const buzzTime = buzz.time || 0;
                    const currentLatest = latestBuzzPerUser.get(buzz.username);
                    if (currentLatest === undefined || buzzTime > (currentLatest.time || 0)) {
                        latestBuzzPerUser.set(buzz.username, buzz);
                    }
                });
            }

            tableBody.innerHTML = buzzes.map(buzz => {
                const timeDiff = buzz.time !== undefined && buzz.time !== null ? buzz.time : 0;
                let rowClass = "";
                if (isMultipleBuzz) {
                    const latestBuzz = latestBuzzPerUser.get(buzz.username);
                    if (latestBuzz && latestBuzz.userId === buzz.userId && (latestBuzz.time || 0) === timeDiff) {
                        rowClass = "latest-buzz";
                    }
                }
                return `<tr class="${rowClass}"><td style="width: 50%;">${buzz.username}</td><td style="width: 50%;">${timeDiff.toFixed(3)}s</td></tr>`;
            }).join('');
        }

        function resolveUserIdFromParticipant(p) {
            if (!p) return '';
            if (p.userId) return String(p.userId);
            if (p.id) return String(p.id);
            if (p.socketId) return String(p.socketId);
            if (p.userid) return String(p.userid);
            try {
                const roomParts = currentRoomData && currentRoomData.participants;
                if (roomParts) {
                    if (Array.isArray(roomParts)) {
                        const found = roomParts.find(r => (r.username && p.username && r.username === p.username) || (r.id && p.id && r.id === p.id));
                        if (found) return String(found.userId || found.id || found.socketId || '');
                    } else {
                        const vals = Object.values(roomParts);
                        const found = vals.find(r => (r.username && p.username && r.username === p.username) || (r.id && p.id && r.id === p.id));
                        if (found) return String(found.userId || found.id || found.socketId || '');
                    }
                }
            } catch (e) { console.warn("resolveUserIdFromParticipant error", e); }
            return '';
        }

        function renderParticipantsList() {
            const participants = Array.isArray(currentParticipants) ? currentParticipants : [];
            if (participants.length === 0) {
                document.getElementById('participantsList').innerHTML = "<p>Chưa có ai tham gia.</p>";
                return;
            }
            const sortedParticipants = [...participants].sort((a, b) => {
                const getRoleScore = (p) => {
                    if (p.isHost) return 1;
                    if (p.isManager) return 2;
                    return 3;
                };
                return getRoleScore(a) - getRoleScore(b);
            });

            document.getElementById('participantsList').innerHTML = sortedParticipants.map(p => {
                let style = "font-weight: bold; font-size: 1.125rem; padding: 0.5rem;";
                let roleClass = "";
                if (p.isHost) { style += "color: #2563EB;"; roleClass = "text-blue-600"; }
                else if (p.isManager) { style += "color: #DC2626;"; roleClass = "text-red-600"; }
                else { style += "color: #000000;"; }
                return `<p class="${roleClass}" style="${style}">${p.username}</p>`;
            }).join('');
        }

        function renderLockUsersList() {
            const listElement = document.getElementById('lockUsersList');
            const participants = Array.isArray(currentParticipants) ? currentParticipants : [];
            const contestants = participants.filter(p => !p.isHost && !p.isManager);

            if (contestants.length === 0) {
                listElement.innerHTML = "<p>Chưa có người tham gia (Player) nào.</p>";
                return;
            }
            let lockedUsers = currentRoomData?.lockedUsers || [];
            listElement.innerHTML = contestants.map(p => {
                const contestantUserId = resolveUserIdFromParticipant(p) || '';
                const valAttr = contestantUserId ? contestantUserId : `uname:${encodeURIComponent(p.username || '')}`;
                let checked = false;
                if (contestantUserId) { checked = lockedUsers.includes(contestantUserId) || lockedUsers.includes(String(contestantUserId)); }
                if (!checked) {
                    const uname = p.username || '';
                    if (uname) { checked = lockedUsers.includes(uname) || lockedUsers.includes(String(uname)); }
                }
                return `<div style="display: flex; align-items: center;">
                <input type="checkbox" id="lock-${valAttr}" value="${valAttr}" style="height: 1.25rem; width: 1.25rem; margin-right: 0.75rem;" ${checked ? 'checked' : ''}>
                <label for="lock-${valAttr}" style="font-weight: bold; font-size: 1.125rem;">${p.username || ('#' + (p.id || 'unknown'))}</label>
            </div>`;
            }).join('');
        }

        function updateLockedUsersUI(lockedUsers) {
            const listElement = document.getElementById('lockUsersList');
            const inputs = listElement ? listElement.querySelectorAll('input[type="checkbox"]') : [];
            if (!inputs || inputs.length === 0) renderLockUsersList();

            const finalInputs = document.querySelectorAll('#lockUsersList input[type="checkbox"]');
            finalInputs.forEach(cb => {
                const v = cb.value || '';
                if (v.startsWith('uname:')) {
                    const uname = decodeURIComponent(v.slice(6));
                    cb.checked = lockedUsers.includes(uname) || lockedUsers.includes(String(uname));
                } else {
                    cb.checked = lockedUsers.includes(v) || lockedUsers.includes(String(v));
                }
            });
        }

        async function saveLockedUsers() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            const lockedUsers = [];
            document.querySelectorAll('#lockUsersList input[type="checkbox"]:checked').forEach(cb => {
                const v = cb.value || '';
                if (!v) return;
                if (v.startsWith('uname:')) lockedUsers.push(decodeURIComponent(v.slice(6)));
                else lockedUsers.push(v);
            });
            await updateRoom({ lockedUsers: lockedUsers });
            closeModal('lockUsersModal');
        }

        function createRoom() {
            if (!userId) return;
            socket.emit('createRoom');
        }

        function confirmJoinRoom() {
            const roomId = document.getElementById('joinRoomCodeInput').value.trim();
            const username = document.getElementById('joinUsernameInput').value.trim();
            if (!roomId || !username || !userId) return;
            socket.emit('joinRoomAsManager', { roomId: roomId, username: username, userId: userId });
        }

        async function updateRoom(data) {
            if (!currentRoomId || (!isHost && !isManager)) return;
            socket.emit('hostUpdateRoom', { roomId: currentRoomId, data: data });
        }

        async function openBell(isTimed = false) {
            if (!currentRoomId || (!isHost && !isManager)) return;

            let status = "open_infinite";
            let payload = { reset: false };

            if (isTimed) {
                status = "open_timed";
                const duration = parseInt(document.getElementById('bellTimeInput').value) || 10;
                if (bellTimer) clearTimeout(bellTimer);

                // Timeout khóa chuông phía Host
                bellTimer = setTimeout(() => { lockBell(); }, duration * 1000);

                // QUAN TRỌNG: Gửi duration (tổng thời gian) lên server để Thí sinh có thể đếm ngược
                payload.bellDuration = duration;
            }

            payload.bellStatus = status;
            await updateRoom(payload);
        }

        async function lockBell() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            if (bellTimer) clearTimeout(bellTimer);
            await updateRoom({ bellStatus: "locked" });
        }

        async function resetBell() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            document.getElementById('buzzTableBody').innerHTML = `<tr><td style="width: 500px;" colspan="2">Đang reset chuông...</td></tr>`;
            let nextStatus = null;
            if (currentRoomData && currentRoomData.bellStatus === 'open_infinite') {
                nextStatus = 'open_infinite';
            }
            const payload = { reset: true };
            if (nextStatus === 'open_infinite') payload.bellStatus = 'open_infinite';
            await updateRoom(payload);
            if (bellTimer) clearTimeout(bellTimer);
        }

        async function resetAllLocks() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            await updateRoom({ lockedUsers: [] });
            renderLockUsersList();
        }

        async function saveBellOptions() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            const buzzCount = document.querySelector('input[name="buzzCount"]:checked').value;
            const buzzMode = document.querySelector('input[name="buzzMode"]:checked').value;
            await updateRoom({ options: { buzzCount, buzzMode } });
            closeModal('bellOptionsModal');
        }

        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', () => { openModal('joinRoomModal'); });
        document.getElementById('closeJoinModalBtn').addEventListener('click', () => { closeModal('joinRoomModal'); });
        document.getElementById('confirmJoinBtn').addEventListener('click', confirmJoinRoom);
        document.getElementById('showParticipantsBtn').addEventListener('click', () => { renderParticipantsList(); openModal('participantsModal'); });
        document.getElementById('showLockUsersBtn').addEventListener('click', () => { renderLockUsersList(); openModal('lockUsersModal'); });
        document.getElementById('showBellOptionsBtn').addEventListener('click', () => { updateBellOptionsUI(currentRoomData.options); openModal('bellOptionsModal'); });
        document.getElementById('openBellInfiniteBtn').addEventListener('click', () => openBell(false));
        document.getElementById('openBellTimedBtn').addEventListener('click', () => openBell(true));
        document.getElementById('lockBellBtn').addEventListener('click', lockBell);
        document.getElementById('resetBellBtn').addEventListener('click', resetBell);
        document.getElementById('saveLockedUsersBtn').addEventListener('click', saveLockedUsers);
        document.getElementById('resetAllLocksBtn').addEventListener('click', resetAllLocks);
        document.getElementById('saveBellOptionsBtn').addEventListener('click', saveBellOptions);

        document.getElementById('createRoomBtn').disabled = true;
        document.getElementById('createRoomBtn').textContent = 'Đang kết nối Server...';
        document.getElementById('joinRoomBtn').disabled = true;
        document.getElementById('joinRoomBtn').textContent = 'Đang kết nối...';
    </script>
</body>

</html>