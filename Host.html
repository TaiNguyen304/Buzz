<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host - Bảng điều khiển</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: #9CA3AF;
            border-radius: 9999px;
        }

        .modal-body::-webkit-scrollbar-track {
            background-color: #F3F4F6;
        }

        .modal-actions-center {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        body {
            background-color: #F3F4F6;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1.5rem;
        }

        .container {
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: blue;
        }

        .flex-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-duration: 200ms;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            flex: 1 1 0%;
            cursor: pointer;
            border: none;
            height: 50px !important;
            margin-top: 10px;
        }

        button:hover {
            background-color: orange !important;
            color: #FFFFFF !important;
        }

        #createRoomBtn,
        #showParticipantsBtn {
            background-color: purple;
            color: #FFFFFF;
        }

        #joinRoomBtn {
            background-color: purple;
            color: #FFFFFF;
        }

        /* Font Arial cho Mã phòng */
        #roomCodeDisplay {
            display: none;
            padding: 0.75rem;
            background-color: purple;
            color: white;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-family: Arial, Helvetica, sans-serif !important;
            text-align: center;
            flex: 1 1 0%;
            font-weight: bold;
        }

        #bellStatusDisplay {
            width: 80%;
            margin: auto;
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #FFFFFF;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            background-color: red;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: red;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        input[type="number"] {
            width: 80%;
            display: block;
            margin-left: auto;
            margin-right: auto;
            padding: 0.5rem;
            border: 1px solid red;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        input[type="text"].modal-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: bold;
            box-sizing: border-box;
        }

        input[type="text"].modal-input:focus {
            outline: 2px solid transparent;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        input[type="number"]:focus {
            outline: 2px solid transparent;
            border-color: red;
            box-shadow: 0 0 0 3px red;
            font-weight: bold;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        #openBellInfiniteBtn,
        #resetBellBtn {
            background-color: blue;
            color: #FFFFFF;
        }

        #openBellTimedBtn,
        #showLockUsersBtn {
            background-color: green;
            color: #FFFFFF;
        }

        #lockBellBtn,
        #showBellOptionsBtn {
            background-color: #ff00cc;
            color: #FFFFFF;
        }

        .overflow-x-auto {
            width: 100%;
            overflow-x: auto;
        }

        .min-w-full {
            min-width: 100%;
        }

        table {
            border-collapse: collapse;
            border: 1px solid #D1D5DB;
        }

        thead th {
            padding: 1rem;
            background-color: rgb(255, 255, 0);
            color: #000000;
            font-weight: bold;
            font-size: 1.125rem;
            border: 1px solid #D1D5DB;
        }

        tbody {
            text-align: center;
            font-size: 1.125rem;
            font-weight: bold;
        }

        tbody td {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            background-color: #FFFFFF;
            color: #000000;
        }

        .latest-buzz {
            background-color: blue !important;
            color: white !important;
        }

        .latest-buzz td {
            background-color: blue !important;
            color: white !important;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition-property: opacity;
            transition-duration: 300ms;
        }

        .modal-content {
            background-color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 32rem;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .modal-body {
            max-height: 16rem;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .modal-close-btn {
            background-color: rgb(255, 0, 0);
            color: #FFFFFF;
        }

        #lockUsersModal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #saveLockedUsersBtn {
            background-color: green;
            color: #FFFFFF;
        }

        #confirmJoinBtn {
            background-color: green;
            color: white;
            font-weight: bold;
        }

        #resetAllLocksBtn {
            background-color: rgb(255, 255, 0);
            color: #000000;
        }

        #lockUsersList>div {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        #lockUsersList input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            color: green;
        }

        #lockUsersList label {
            text-align: left;
            display: inline;
            color: #111827;
            font-weight: normal;
            font-size: 1rem;
            margin: 0;
            padding: 0;
            cursor: pointer;
        }

        #saveBellOptionsBtn {
            background-color: green;
            color: #FFFFFF;
            font-weight: bold;
        }

        #bellOptionsModal .flex.items-center label {
            display: inline;
            margin-bottom: 0;
            text-align: left;
        }

        #joinRoomModal label {
            text-align: left;
            color: #111827;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        #joinRoomModal .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: none;
        }

        #hostTimerDisplay {
            display: block;
            width: 80%;
            height: 50px;
            margin: 0 auto 1rem auto;
            background-color: #FFFF00;
            color: #000000;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            justify-content: center;
            align-items: center;
            border: 3px solid #000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans p-6">
    <div class="container">
        <h1>Bảng điều khiển Host</h1>
        <div class="flex-wrap">
            <button id="createRoomBtn" disabled>Đang kết nối Server...</button>
            <button id="joinRoomBtn" disabled>Đang kết nối...</button>
            <div id="roomCodeDisplay">Mã phòng: </div>
            <button id="showParticipantsBtn" disabled>Danh sách tham gia</button>
        </div>
        <div id="bellControlSection" style="display: none;">
            <div id="bellStatusDisplay">CHUÔNG ĐANG KHÓA</div>
            <div id="hostTimerDisplay">Thời gian: 0.000s</div>
            <label for="bellTimeInput">Thời gian mở chuông (giây):</label>
            <input type="number" id="bellTimeInput" value="10">
            <div class="grid-container">
                <button id="openBellInfiniteBtn" disabled>Mở chuông vĩnh viễn</button>
                <button id="openBellTimedBtn" disabled>Mở chuông (Giới hạn)</button>
                <button id="lockBellBtn" disabled>Khóa chuông</button>
            </div>
            <div class="grid-container">
                <button id="resetBellBtn" disabled>Reset chuông</button>
                <button id="showLockUsersBtn" disabled>Chọn người bị khóa chuông</button>
                <button id="showBellOptionsBtn" disabled>Tùy chọn chuông</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Tên người chơi</th>
                            <th style="width: 50%;">Thời gian bấm chuông</th>
                        </tr>
                    </thead>
                    <tbody id="buzzTableBody">
                        <tr>
                            <td colspan="2">Chưa có ai bấm chuông</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="participantsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Danh sách người tham gia</h2>
            <div id="participantsList" class="modal-body"></div>
            <div class="modal-actions-center"><button onclick="closeModal('participantsModal')"
                    class="modal-close-btn text-white">Đóng</button></div>
        </div>
    </div>
    <div id="lockUsersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Chọn người bị khóa chuông</h2>
            <div id="lockUsersList" class="modal-body space-y-2"></div>
            <div class="mt-6 modal-actions"><button id="saveLockedUsersBtn">Lưu</button><button
                    id="resetAllLocksBtn">Reset tất cả</button><button onclick="closeModal('lockUsersModal')"
                    class="modal-close-btn">Đóng</button></div>
        </div>
    </div>
    <div id="bellOptionsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Tùy chọn chuông</h2>
            <div class="modal-body space-y-4">
                <div>
                    <h3 class="font-bold text-lg mb-2">Số lần bấm chuông/vòng:</h3>
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center"><input type="radio" id="opt-single-buzz" name="buzzCount"
                                value="single" checked class="mr-3"><label for="opt-single-buzz"
                                class="text-base text-gray-900">Mỗi người chỉ được bấm 1 lần/vòng</label></div>
                        <div class="flex items-center"><input type="radio" id="opt-multiple-buzz" name="buzzCount"
                                value="multiple" class="mr-3"><label for="opt-multiple-buzz"
                                class="text-base text-gray-900">Mỗi người được bấm nhiều lần</label></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">Chế độ người thắng:</h3>
                    <div class="flex flex-col space-y-2">
                        <div class="flex flex-col space-y-2">
                            <div class="flex items-center"><input type="radio" id="opt-single-winner" name="buzzMode"
                                    value="single-winner" checked class="mr-3"><label for="opt-single-winner"
                                    class="text-base text-gray-900">Một người bấm: Khóa chuông ngay lập tức</label>
                            </div>
                            <div class="flex items-center"><input type="radio" id="opt-all-buzz" name="buzzMode"
                                    value="all-buzz" class="mr-3"><label for="opt-all-buzz"
                                    class="text-base text-gray-900">Tất cả đều bấm: Chỉ khóa chuông khi Host bấm
                                    Khóa</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions-center"><button id="saveBellOptionsBtn">Lưu</button><button
                    onclick="closeModal('bellOptionsModal')" class="modal-close-btn">Đóng</button></div>
        </div>
    </div>
    <div id="joinRoomModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Tham gia với tư cách Quản lý</h2>
            <div class="modal-body">
                <div><label for="joinRoomCodeInput">Nhập mã phòng:</label><input type="text" id="joinRoomCodeInput"
                        class="modal-input"></div>
                <div><label for="joinUsernameInput">Nhập Username:</label><input type="text" id="joinUsernameInput"
                        class="modal-input"></div>
            </div>
            <div class="modal-actions-center"><button id="confirmJoinBtn">Xác nhận</button><button
                    id="closeJoinModalBtn" class="modal-close-btn">Đóng</button></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://buzz1.onrender.com';
        const socket = io(SERVER_URL);
        let userId = null, currentRoomId = null, currentRoomData = null, bellTimer = null, currentParticipants = [];
        let isHost = false, isManager = false, countdownInterval = null;
        const hostTimerDisplay = document.getElementById('hostTimerDisplay');

        socket.on('connect', () => {
            userId = `host-${socket.id}`;
            document.getElementById('createRoomBtn').disabled = false;
            document.getElementById('joinRoomBtn').disabled = false;
            document.getElementById('createRoomBtn').textContent = 'Tạo phòng';
            document.getElementById('joinRoomBtn').textContent = 'Tham gia phòng (Quản lý)';
        });
        socket.on('roomCreated', (data) => { setupRoom(data, true, false); });
        socket.on('joinedAsManager', (data) => { setupRoom(data, false, true); closeModal('joinRoomModal'); });
        socket.on('roomClosed', () => window.location.reload());
        socket.on('roomStateUpdate', handleRoomStateUpdate);

        function setupRoom(data, host, manager) {
            currentRoomId = data.roomId; isHost = host; isManager = manager;
            document.getElementById('roomCodeDisplay').textContent = `Mã phòng: ${currentRoomId}`;
            document.getElementById('roomCodeDisplay').style.display = 'block';
            document.getElementById('createRoomBtn').textContent = isHost ? `Mã phòng: ${currentRoomId}` : `Đã tham gia: ${currentRoomId}`;
            document.getElementById('createRoomBtn').disabled = true;
            document.getElementById('joinRoomBtn').style.display = 'none';
            enableButtons();
            document.getElementById('bellControlSection').style.display = 'block';
            if (data.roomState) handleRoomStateUpdate(data.roomState); else updateBellUI("locked");
        }

        function handleRoomStateUpdate(data) {
            currentRoomData = data;
            currentParticipants = Array.isArray(data.participants) ? data.participants : [];
            document.getElementById('showParticipantsBtn').textContent = `Danh sách tham gia (${currentParticipants.filter(p => !p.isHost && !p.isManager).length})`;
            updateBellUI(data.bellStatus);
            updateBellOptionsUI(data.options);
            renderBuzzTable(data.buzzes || []);
            updateLockedUsersUI(data.lockedUsers || []);

            // XỬ LÝ ĐẾM NGƯỢC VÀ KHÓA KHI HẾT GIỜ
            if (data.bellStatus === 'open_timed' && data.bellOpenTimestamp && data.bellDuration) {
                startCountdown(data.bellDuration, data.bellOpenTimestamp);
            } else {
                stopCountdown();
            }
        }

        function startCountdown(duration, startTime) {
            if (countdownInterval) clearInterval(countdownInterval);
            const start = Number(startTime);
            const updateTimer = () => {
                const now = Date.now();
                const elapsed = (now - start) / 1000;
                const remaining = duration - elapsed;
                if (remaining <= 0) {
                    hostTimerDisplay.textContent = "Thời gian: 0.000s";
                    clearInterval(countdownInterval);
                    // Khi hết giờ, Host gửi lệnh khóa nếu chưa khóa
                    if (currentRoomData.bellStatus === 'open_timed' && (isHost || isManager)) {
                        lockBell();
                    }
                } else {
                    hostTimerDisplay.textContent = "Thời gian: " + remaining.toFixed(3) + "s";
                }
            };
            updateTimer();
            countdownInterval = setInterval(updateTimer, 33);
        }

        function stopCountdown() { if (countdownInterval) clearInterval(countdownInterval); hostTimerDisplay.textContent = "Thời gian: 0.000s"; }

        async function openBell(isTimed = false) {
            if (!currentRoomId || (!isHost && !isManager)) return;

            // [FIX] Đảm bảo chỉ đọc giá trị số nguyên từ input
            const durationInput = document.getElementById('bellTimeInput');
            const duration = parseInt(durationInput.value) || 10;

            let status = isTimed ? "open_timed" : "open_infinite";

            // Payload chỉ gửi duration (đã được sửa lỗi +5s)
            let payload = {
                bellStatus: status,
                reset: false,
                bellDuration: isTimed ? duration : null
            };

            // Bỏ chạy countdown ngay lập tức (optimistic) trên Host
            // Đồng hồ sẽ bắt đầu chạy khi nhận được roomStateUpdate từ Server (đảm bảo đồng bộ)
            await updateRoom(payload);
        }

        async function lockBell() {
            if (!currentRoomId || (!isHost && !isManager)) return;
            if (bellTimer) clearTimeout(bellTimer);
            await updateRoom({ bellStatus: "locked" });
        }

        async function updateRoom(data) { socket.emit('hostUpdateRoom', { roomId: currentRoomId, data: data }); }

        // Các hàm tiện ích khác (giữ nguyên)
        function enableButtons() {
            const isController = isHost || isManager;
            const ids = ['openBellInfiniteBtn', 'openBellTimedBtn', 'lockBellBtn', 'resetBellBtn', 'showLockUsersBtn', 'showBellOptionsBtn'];
            ids.forEach(id => document.getElementById(id).disabled = !isController);
            document.getElementById('showParticipantsBtn').disabled = false;
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function updateBellUI(status) {
            const d = document.getElementById('bellStatusDisplay');
            d.style.backgroundColor = status === 'open_infinite' ? 'blue' : (status === 'open_timed' ? 'green' : (status === 'locked_winner' ? '#ff00cc' : 'red'));
            d.textContent = status === 'open_infinite' ? 'CHUÔNG ĐANG MỞ (VÔ HẠN)' : (status === 'open_timed' ? 'CHUÔNG ĐANG MỞ (CÓ GIỚI HẠN)' : (status === 'locked_winner' ? 'ĐÃ CÓ NGƯỜI BẤM!' : 'CHUÔNG ĐANG KHÓA'));
        }
        function updateBellOptionsUI(opt) { if (opt) { document.getElementById('opt-single-buzz').checked = opt.buzzCount === 'single'; document.getElementById('opt-multiple-buzz').checked = opt.buzzCount === 'multiple'; document.getElementById('opt-single-winner').checked = opt.buzzMode === 'single-winner'; document.getElementById('opt-all-buzz').checked = opt.buzzMode === 'all-buzz'; } }
        function renderBuzzTable(buzzes) {
            const tbody = document.getElementById('buzzTableBody');
            if (!buzzes.length) { tbody.innerHTML = `<tr><td colspan="2">Chưa có ai bấm chuông</td></tr>`; return; }
            const isMulti = currentRoomData?.options?.buzzCount === 'multiple';
            const latestMap = new Map();
            if (isMulti) buzzes.forEach(b => { if (!latestMap.has(b.username) || b.time > latestMap.get(b.username).time) latestMap.set(b.username, b); });
            tbody.innerHTML = buzzes.map(b => { const isLatest = isMulti && latestMap.get(b.username).userId === b.userId && latestMap.get(b.username).time === b.time; return `<tr class="${isLatest ? 'latest-buzz' : ''}"><td style="width:50%;">${b.username}</td><td style="width:50%;">${(b.time || 0).toFixed(3)}s</td></tr>`; }).join('');
        }
        function resolveUserId(p) { return String(p.userId || p.id || p.socketId || p.userid || ''); }
        function renderLockList() {
            const contestants = currentParticipants.filter(p => !p.isHost && !p.isManager);
            const div = document.getElementById('lockUsersList');
            if (!contestants.length) { div.innerHTML = "<p>Chưa có người tham gia.</p>"; return; }
            const locked = currentRoomData?.lockedUsers || [];
            div.innerHTML = contestants.map(p => { const uid = resolveUserId(p); const val = uid || `uname:${encodeURIComponent(p.username)}`; const isLocked = locked.includes(val) || (p.username && locked.includes(p.username)); return `<div style="display:flex;align-items:center;"><input type="checkbox" value="${val}" style="height:1.25rem;width:1.25rem;margin-right:0.75rem;" ${isLocked ? 'checked' : ''}><label>${p.username}</label></div>`; }).join('');
        }
        function updateLockedUsersUI(locked) { if (!document.querySelector('#lockUsersList input')) renderLockList(); }

        document.getElementById('createRoomBtn').onclick = () => { if (userId) socket.emit('createRoom'); };
        document.getElementById('joinRoomBtn').onclick = () => openModal('joinRoomModal');
        document.getElementById('closeJoinModalBtn').onclick = () => closeModal('joinRoomModal');
        document.getElementById('confirmJoinBtn').onclick = () => { const r = document.getElementById('joinRoomCodeInput').value.trim(); const u = document.getElementById('joinUsernameInput').value.trim(); if (r && u && userId) socket.emit('joinRoomAsManager', { roomId: r, username: u, userId }); };
        document.getElementById('showParticipantsBtn').onclick = () => { const pList = currentParticipants; document.getElementById('participantsList').innerHTML = pList.length ? pList.map(p => `<p style="font-weight:bold;padding:0.5rem;color:${p.isHost ? 'blue' : (p.isManager ? 'red' : 'black')}">${p.username}</p>`).join('') : "<p>Chưa có ai.</p>"; openModal('participantsModal'); };
        document.getElementById('showLockUsersBtn').onclick = () => { renderLockList(); openModal('lockUsersModal'); };
        document.getElementById('saveLockedUsersBtn').onclick = async () => { const l = []; document.querySelectorAll('#lockUsersList input:checked').forEach(c => l.push(c.value.startsWith('uname:') ? decodeURIComponent(c.value.slice(6)) : c.value)); await updateRoom({ lockedUsers: l }); closeModal('lockUsersModal'); };
        document.getElementById('resetAllLocksBtn').onclick = async () => { await updateRoom({ lockedUsers: [] }); renderLockList(); };
        document.getElementById('showBellOptionsBtn').onclick = () => { updateBellOptionsUI(currentRoomData.options); openModal('bellOptionsModal'); };
        document.getElementById('saveBellOptionsBtn').onclick = async () => { const bc = document.querySelector('input[name="buzzCount"]:checked').value; const bm = document.querySelector('input[name="buzzMode"]:checked').value; await updateRoom({ options: { buzzCount: bc, buzzMode: bm } }); closeModal('bellOptionsModal'); };
        document.getElementById('openBellInfiniteBtn').onclick = () => openBell(false);
        document.getElementById('openBellTimedBtn').onclick = () => openBell(true);
        document.getElementById('lockBellBtn').onclick = lockBell;
        document.getElementById('resetBellBtn').onclick = async () => { document.getElementById('buzzTableBody').innerHTML = `<tr><td colspan="2">Đang reset...</td></tr>`; await updateRoom({ reset: true, bellStatus: currentRoomData?.bellStatus === 'open_infinite' ? 'open_infinite' : undefined }); };
    </script>
</body>

</html>