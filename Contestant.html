<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thí sinh - Bấm chuông</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Global Styles */
        body {
            background-color: #F3F4F6;
            color: #111827;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            max-width: 32rem;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        /* Login Section */
        #loginSection {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #loginSection h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: blue;
        }

        .space-y-4>div {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: purple;
            margin-bottom: 0.25rem;
            text-align: center;
            align-items: center;
        }

        input[type="number"],
        input[type="text"] {
            width: 94%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 1.125rem;
            text-align: center;
            align-items: center;
            font-weight: bold;
        }

        input[type="number"] {
            font-family: Arial, Helvetica, sans-serif, monospace;
        }

        #roomCodeInput {
            background-color: white;
            color: black !important;
            font-weight: bold;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        #joinRoomBtn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-property: all;
            transition-duration: 200ms;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            background-color: yellow;
            color: #000000;
            width: 100%;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
        }

        #joinRoomBtn:hover {
            background-color: orange;
            color: #FFFFFF;
        }

        #errorMessage {
            color: red;
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
        }

        /* Buzzer Section */
        #buzzerSection {
            text-align: center;
        }

        #buzzerSection h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        #roomCodeDisplay {
            font-family: Arial, Helvetica, sans-serif, monospace;
            color: blue;
        }

        #buzzerSection h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        #usernameDisplay {
            color: purple;
        }

        .buzzer-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        #buzzerBtn {
            width: 100%;
            max-width: 500px;
            height: 100px;
            font-size: 1.875rem;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition-property: all;
            transition-duration: 200ms;
            transform-origin: center;
            border: none;
        }

        #buzzerBtn.active {
            background-color: green;
            color: #FFFFFF;
            cursor: pointer;
        }

        #buzzerBtn.active:hover {
            background-color: orange;
            transform: scale(1.05);
        }

        #buzzerBtn.buzzed {
            background-color: blue;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        #buzzerBtn.locked {
            background-color: red;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        /* Buzzer Status Display */
        #buzzerStatus {
            width: 100%;
            max-width: 32rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: bold;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        #buzzerStatus.status-waiting {
            background-color: #ff00cc;
            color: #FFFFFF;
        }

        #buzzerStatus.status-active {
            background-color: green;
            color: white;
        }

        #buzzerStatus.status-buzzed {
            background-color: red;
            color: #FFFFFF;
        }

        /* --- CẬP NHẬT CSS TIMER: Luôn hiển thị --- */
        #timerDisplay {
            display: block;
            /* Luôn hiển thị */
            width: 100%;
            max-width: 500px;
            background-color: #FFFF00;
            color: #000000;
            font-weight: bold;
            font-size: 2.5rem;
            padding: 0.5rem 0;
            border-radius: 0.5rem;
            border: 3px solid #000;
            text-align: center;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans p-6 flex items-center justify-center min-h-screen">

    <div class="container">

        <div id="loginSection">
            <h1>Tham gia phòng</h1>
            <div class="space-y-4">
                <div>
                    <label for="roomCodeInput">Mã phòng (6 chữ số):</label>
                    <input type="number" id="roomCodeInput" maxlength="6">
                </div>
                <div>
                    <label for="usernameInput">Username (Tên của bạn):</label>
                    <input type="text" id="usernameInput">
                </div>
                <button id="joinRoomBtn">Xác nhận</button>
            </div>
            <p id="errorMessage"></p>
        </div>

        <div id="buzzerSection" style="display: none;">
            <h2>Phòng <span id="roomCodeDisplay"></span></h2>
            <h3>Chào, <span id="usernameDisplay"></span></h3>

            <div class="buzzer-controls">
                <div id="timerDisplay">0.000s</div>

                <button id="buzzerBtn" disabled>Đang kết nối...</button>
                <div id="buzzerStatus" class="status-waiting">Vui lòng chờ Host...</div>
            </div>
        </div>

    </div>

    <script>
        const SERVER_URL = 'https://buzz1.onrender.com';
        const socket = io(SERVER_URL);

        let userId = null;
        let currentRoomId = null;
        let username = null;
        let currentRoomData = null;
        let iHaveBuzzed = false;
        let myBuzzTime = null;
        let countdownInterval = null;

        const loginSection = document.getElementById('loginSection');
        const buzzerSection = document.getElementById('buzzerSection');
        const buzzerBtn = document.getElementById('buzzerBtn');
        const buzzerStatus = document.getElementById('buzzerStatus');
        const errorMessage = document.getElementById('errorMessage');
        const timerDisplay = document.getElementById('timerDisplay');

        socket.on('connect', () => {
            userId = `user-${socket.id}`;
            document.getElementById('joinRoomBtn').textContent = 'Xác nhận';
            document.getElementById('joinRoomBtn').disabled = false;
        });

        socket.on('joinRoomError', (data) => {
            errorMessage.textContent = data.message;
            document.getElementById('joinRoomBtn').disabled = false;
        });

        socket.on('roomJoined', (data) => {
            currentRoomId = data.roomId;
            username = data.username;
            let resolvedId = null;
            if (data.userId) resolvedId = data.userId;
            else if (data.id) resolvedId = data.id;
            else if (data.socketId) resolvedId = data.socketId;
            if (resolvedId) userId = String(resolvedId);

            loginSection.style.display = 'none';
            buzzerSection.style.display = 'block';
            document.getElementById('roomCodeDisplay').textContent = currentRoomId;
            document.getElementById('usernameDisplay').textContent = username;
            errorMessage.textContent = "";

            iHaveBuzzed = false;
            myBuzzTime = null;
            updateBuzzerUI();
        });

        socket.on('roomClosed', (data) => {
            setBuzzerState("locked", data.message);
            setTimeout(() => window.location.reload(), 3000);
        });

        socket.on('roomStateUpdate', (data) => {
            const oldBellSessionId = currentRoomData ? currentRoomData.bellSessionId : null;
            currentRoomData = data;
            if (oldBellSessionId && oldBellSessionId !== currentRoomData.bellSessionId) {
                iHaveBuzzed = false;
                myBuzzTime = null;
            }
            const myBuzzInThisSession = currentRoomData.buzzes.find(b => b.userId === userId && b.bellSessionId === currentRoomData.bellSessionId);
            if (myBuzzInThisSession) {
                iHaveBuzzed = true;
                myBuzzTime = myBuzzInThisSession.time;
            } else {
                iHaveBuzzed = false;
                myBuzzTime = null;
            }
            updateBuzzerUI();
        });

        function joinRoom() {
            if (!userId) return;
            const roomId = document.getElementById('roomCodeInput').value;
            const inputUsername = document.getElementById('usernameInput').value.trim();
            if (!roomId || roomId.length !== 6) {
                errorMessage.textContent = "Mã phòng phải là 6 chữ số.";
                return;
            }
            if (!inputUsername) {
                errorMessage.textContent = "Vui lòng nhập Username.";
                return;
            }
            errorMessage.textContent = "Đang tham gia phòng...";
            document.getElementById('joinRoomBtn').disabled = true;
            socket.emit('joinRoom', { roomId, username: inputUsername });
        }

        function startCountdown(duration, startTime) {
            if (countdownInterval) clearInterval(countdownInterval);

            // timerDisplay đã luôn hiển thị rồi, không cần chỉnh style.display
            const updateTimer = () => {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                const remaining = duration - elapsed;
                if (remaining <= 0) {
                    timerDisplay.textContent = "0.000s";
                    clearInterval(countdownInterval);
                } else {
                    timerDisplay.textContent = remaining.toFixed(3) + "s";
                }
            };
            updateTimer();
            countdownInterval = setInterval(updateTimer, 30);
        }

        function stopCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            timerDisplay.textContent = "0.000s"; // Reset về 0
        }

        function setBuzzerState(state, message) {
            buzzerBtn.disabled = true;
            buzzerBtn.className = "";
            buzzerStatus.className = "";
            if (state === 'active') {
                buzzerBtn.disabled = false;
                buzzerBtn.textContent = "BẤM CHUÔNG!";
                buzzerBtn.classList.add('active');
                buzzerStatus.textContent = "Sẵn sàng bấm!";
                buzzerStatus.classList.add('status-active');
            } else if (state === 'buzzed') {
                buzzerBtn.textContent = "Đã bấm";
                buzzerBtn.classList.add('buzzed');
                buzzerStatus.textContent = message;
                buzzerStatus.classList.add('status-buzzed');
            } else if (state === 'locked') {
                buzzerBtn.textContent = message;
                buzzerBtn.classList.add('locked');
                buzzerStatus.textContent = message;
                buzzerStatus.classList.add('status-waiting');
            }
        }

        function updateBuzzerUI() {
            if (!currentRoomData) {
                setBuzzerState("locked", "Đang tải...");
                return;
            }
            // Chỉ chạy đồng hồ khi là chế độ open_timed
            if (currentRoomData.bellStatus === 'open_timed' && currentRoomData.bellOpenTimestamp && currentRoomData.bellDuration) {
                startCountdown(currentRoomData.bellDuration, currentRoomData.bellOpenTimestamp);
            } else {
                stopCountdown();
            }

            const lockedUsersList = currentRoomData.lockedUsers || [];
            const normalizedLockedList = lockedUsersList.map(item => String(item).trim());
            const normalizedUserId = String(userId).trim();
            const normalizedUsername = String(username).trim();

            if (normalizedLockedList.includes(normalizedUserId) || normalizedLockedList.includes(normalizedUsername)) {
                setBuzzerState("locked", "Bạn đã bị Host khóa chuông");
                return;
            }
            if (currentRoomData.bellStatus === 'locked' || currentRoomData.bellStatus === 'locked_winner') {
                setBuzzerState("locked", "Chuông đang khóa");
                return;
            }
            if (iHaveBuzzed && currentRoomData.options.buzzCount === 'single') {
                const timeMessage = myBuzzTime !== null && myBuzzTime >= 0
                    ? `Đã bấm chuông: ${myBuzzTime.toFixed(3)}s`
                    : "Bạn đã bấm chuông!";
                setBuzzerState("buzzed", timeMessage);
                return;
            }
            if (currentRoomData.bellStatus.startsWith('open')) {
                setBuzzerState("active", "BẤM CHUÔNG!");
                return;
            }
            setBuzzerState("locked", "Đang chờ Host...");
        }

        function handleBuzzerClick() {
            if (!currentRoomData || !userId || buzzerBtn.disabled || !currentRoomData.bellSessionId) return;
            setBuzzerState("buzzed", "Đã bấm!");
            socket.emit('buzz', {
                roomId: currentRoomId,
                username: username,
                userId: userId,
                bellSessionId: currentRoomData.bellSessionId
            });
        }

        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        buzzerBtn.addEventListener('click', handleBuzzerClick);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Control' && !event.repeat) {
                if (buzzerSection.style.display === 'none') return;
                handleBuzzerClick();
            }
        });
        setBuzzerState("locked", "Vui lòng chờ Host...");
    </script>
</body>

</html>