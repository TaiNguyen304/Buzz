<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thí sinh - Bấm chuông</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            background-color: #F3F4F6;
            color: #111827;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            max-width: 32rem;
            margin: auto;
            width: 100%;
        }

        #loginSection {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3 {
            font-weight: bold;
            text-align: center;
        }

        h1 {
            font-size: 1.875rem;
            color: blue;
            margin-bottom: 1.5rem;
        }

        .space-y-4>div {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: purple;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        input {
            width: 94%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            text-align: center;
            font-weight: bold;
        }

        #joinRoomBtn {
            padding: 0.75rem;
            width: 100%;
            border-radius: 0.5rem;
            font-weight: bold;
            background-color: yellow;
            border: none;
            cursor: pointer;
            font-size: 1.125rem;
        }

        #joinRoomBtn:hover {
            background-color: orange;
            color: white;
        }

        #errorMessage {
            color: red;
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
        }

        #buzzerSection {
            text-align: center;
            display: none;
        }

        .buzzer-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        #buzzerBtn {
            width: 100%;
            max-width: 500px;
            height: 100px;
            font-size: 1.875rem;
            font-weight: bold;
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        #buzzerBtn.active {
            background-color: green;
            color: white;
            cursor: pointer;
        }

        #buzzerBtn.active:hover {
            background-color: orange;
            transform: scale(1.02);
        }

        #buzzerBtn.buzzed {
            background-color: blue;
            color: white;
            cursor: not-allowed;
        }

        #buzzerBtn.locked {
            background-color: red;
            color: white;
            cursor: not-allowed;
        }

        #buzzerStatus {
            width: 100%;
            max-width: 32rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: bold;
            border-radius: 0.5rem;
        }

        .status-waiting {
            background-color: #ff00cc;
            color: white;
        }

        .status-active {
            background-color: green;
            color: white;
        }

        .status-buzzed {
            background-color: red;
            color: white;
        }

        #timerDisplay {
            display: block;
            width: 100%;
            max-width: 500px;
            height: 50px;
            background-color: #FFFF00;
            color: #000000;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 0.5rem 0;
            border-radius: 0.5rem;
            border: 3px solid #000;
            text-align: center !important;
            justify-content: center !important;
            align-items: center !important;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="loginSection">
            <h1>Tham gia phòng</h1>
            <div class="space-y-4">
                <div><label>Mã phòng (6 chữ số):</label><input type="number" id="roomCodeInput" maxlength="6"></div>
                <div><label>Username (Tên của bạn):</label><input type="text" id="usernameInput"></div>
                <button id="joinRoomBtn">Xác nhận</button>
            </div>
            <p id="errorMessage"></p>
        </div>

        <div id="buzzerSection">
            <h2>Phòng <span id="roomCodeDisplay" style="color:blue;"></span></h2>
            <h3>Chào, <span id="usernameDisplay" style="color:purple;"></span></h3>
            <div class="buzzer-controls">
                <div id="timerDisplay">Thời gian: 0.000s</div>
                <button id="buzzerBtn" disabled>Đang kết nối...</button>
                <div id="buzzerStatus" class="status-waiting">Vui lòng chờ Host...</div>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://buzz1.onrender.com';
        const socket = io(SERVER_URL);
        let userId = null, currentRoomId = null, username = null, currentRoomData = null;
        let iHaveBuzzed = false, myBuzzTime = null, countdownInterval = null;

        const els = { login: document.getElementById('loginSection'), buzzer: document.getElementById('buzzerSection'), btn: document.getElementById('buzzerBtn'), status: document.getElementById('buzzerStatus'), err: document.getElementById('errorMessage'), timer: document.getElementById('timerDisplay') };

        socket.on('connect', () => { userId = `user-${socket.id}`; document.getElementById('joinRoomBtn').disabled = false; });
        socket.on('joinRoomError', (data) => { els.err.textContent = data.message; document.getElementById('joinRoomBtn').disabled = false; });
        socket.on('roomJoined', (data) => {
            currentRoomId = data.roomId; username = data.username;
            if (data.userId) userId = String(data.userId);
            els.login.style.display = 'none'; els.buzzer.style.display = 'block';
            document.getElementById('roomCodeDisplay').textContent = currentRoomId;
            document.getElementById('usernameDisplay').textContent = username;
            els.err.textContent = "";
            updateBuzzerUI();
        });
        socket.on('roomClosed', (data) => { setBuzzerState("locked", data.message); setTimeout(() => window.location.reload(), 3000); });
        socket.on('roomStateUpdate', (data) => {
            const oldSession = currentRoomData?.bellSessionId;
            currentRoomData = data;
            if (oldSession && oldSession !== data.bellSessionId) { iHaveBuzzed = false; myBuzzTime = null; }
            const myBuzz = data.buzzes.find(b => b.userId === userId && b.bellSessionId === data.bellSessionId);
            if (myBuzz) { iHaveBuzzed = true; myBuzzTime = myBuzz.time; } else { iHaveBuzzed = false; myBuzzTime = null; }
            updateBuzzerUI();
        });

        function joinRoom() {
            if (!userId) return;
            const r = document.getElementById('roomCodeInput').value;
            const u = document.getElementById('usernameInput').value.trim();
            if (!r || !u) { els.err.textContent = "Vui lòng nhập đủ thông tin."; return; }
            els.err.textContent = "Đang tham gia...";
            document.getElementById('joinRoomBtn').disabled = true;
            socket.emit('joinRoom', { roomId: r, username: u });
        }

        function startCountdown(duration, startTime) {
            if (countdownInterval) clearInterval(countdownInterval);
            const start = Number(startTime);
            const updateTimer = () => {
                const now = Date.now();
                const elapsed = (now - start) / 1000;
                const remaining = duration - elapsed;
                if (remaining <= 0) {
                    els.timer.textContent = "Thời gian: 0.000s";
                    clearInterval(countdownInterval);
                    setBuzzerState("locked", "Hết giờ!");
                } else {
                    els.timer.textContent = "Thời gian: " + remaining.toFixed(3) + "s";
                }
            };
            updateTimer();
            countdownInterval = setInterval(updateTimer, 33);
        }
        function stopCountdown() { if (countdownInterval) clearInterval(countdownInterval); els.timer.textContent = "Thời gian: 0.000s"; }

        function setBuzzerState(state, msg) {
            els.btn.disabled = true; els.btn.className = ""; els.status.className = "";
            if (state === 'active') {
                els.btn.disabled = false; els.btn.textContent = "BẤM CHUÔNG!"; els.btn.classList.add('active');
                els.status.textContent = "Sẵn sàng bấm!"; els.status.classList.add('status-active');
            } else if (state === 'buzzed') {
                els.btn.textContent = "Đã bấm"; els.btn.classList.add('buzzed');
                els.status.textContent = msg; els.status.classList.add('status-buzzed');
            } else {
                els.btn.textContent = msg; els.btn.classList.add('locked');
                els.status.textContent = msg; els.status.classList.add('status-waiting');
            }
        }

        function updateBuzzerUI() {
            if (!currentRoomData) { setBuzzerState("locked", "Đang tải..."); return; }
            // Chỉ chạy countdown khi bellSessionId thay đổi
            if (currentRoomData.bellStatus === 'open_timed' &&
                currentRoomData.bellOpenTimestamp &&
                currentRoomData.bellDuration) {

                if (!window._lastBellSessionId ||
                    window._lastBellSessionId !== currentRoomData.bellSessionId) {

                    window._lastBellSessionId = currentRoomData.bellSessionId;
                    startCountdown(currentRoomData.bellDuration, currentRoomData.bellOpenTimestamp);
                }
            }
            else {
                stopCountdown();
            }
            const locked = (currentRoomData.lockedUsers || []).map(s => String(s).trim());
            if (locked.includes(String(userId).trim()) || locked.includes(String(username).trim())) { setBuzzerState("locked", "Bạn đã bị Host khóa chuông"); return; }
            if (currentRoomData.bellStatus === 'locked' || currentRoomData.bellStatus === 'locked_winner') { setBuzzerState("locked", "Chuông đang khóa"); return; }
            if (iHaveBuzzed && currentRoomData.options.buzzCount === 'single') { setBuzzerState("buzzed", myBuzzTime != null ? `Đã bấm: ${myBuzzTime.toFixed(3)}s` : "Bạn đã bấm!"); return; }
            if (currentRoomData.bellStatus.startsWith('open')) { setBuzzerState("active", "BẤM CHUÔNG!"); return; }
            setBuzzerState("locked", "Đang chờ Host...");
        }

        function handleBuzzerClick() {
            if (!currentRoomData || !userId || els.btn.disabled || !currentRoomData.bellSessionId) return;
            setBuzzerState("buzzed", "Đã bấm!");
            socket.emit('buzz', { roomId: currentRoomId, username: username, userId: userId, bellSessionId: currentRoomData.bellSessionId });
        }

        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        els.btn.addEventListener('click', handleBuzzerClick);
        document.addEventListener('keydown', (e) => { if (e.key === 'Control' && !e.repeat && els.buzzer.style.display !== 'none') handleBuzzerClick(); });
        setBuzzerState("locked", "Vui lòng chờ Host...");
    </script>
</body>

</html>